<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector de DistracciÃ³n al Volante | IA</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS GENERALES Y LAYOUT --- */
        :root {
            --color-primary: #1E88E5; /* Azul brillante para acciÃ³n */
            --color-secondary: #00bcd4; /* Cian para contraste */
            --color-text: #333;
            --color-background: #eef1f6;
            --color-safe: #4CAF50; /* Verde */
            --color-danger: #D32F2F; /* Rojo */
            --color-warning: #FFC107; /* Amarillo */
            --color-reset: #6c757d; /* Gris para limpiar */
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            width: 95%;
            margin: 40px 20px;
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out;
        }

        /* --- TÃTULOS Y DESCRIPCIONES --- */
        h1 {
            color: var(--color-primary);
            text-align: center;
            font-weight: 700;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        h1 svg {
            margin-right: 10px;
            fill: var(--color-primary);
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-top: 0;
            margin-bottom: 30px;
            font-weight: 300;
        }
        h2 {
            color: var(--color-text);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 30px;
            font-weight: 600;
        }

        /* --- SECCIÃ“N DE SUBIDA (DRAG & DROP) --- */
        .upload-section {
            border: 3px dashed #bbdefb; /* Borde suave */
            background-color: #f7fbff; /* Fondo muy claro */
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-section:hover {
            border-color: var(--color-primary);
            background-color: #e3f2fd;
        }

        #upload-text {
            color: #666;
            font-weight: 600;
            font-size: 1.1em;
            display: block; /* Aseguramos que se muestre por defecto */
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 350px;
            width: auto;
            height: auto;
            border: 3px solid var(--color-primary);
            margin-top: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            object-fit: contain; /* Asegura que la imagen se vea bien */
            display: none;
        }

        /* --- BOTONES DE ACCIÃ“N --- */
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        .button-group button {
            padding: 15px;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
        }

        #predict-button {
            flex-grow: 3; /* MÃ¡s ancho */
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 4px 10px rgba(30, 136, 229, 0.4);
        }
        #predict-button:hover:not(:disabled) {
            background-color: #0d47a1; /* Azul mÃ¡s oscuro */
            transform: translateY(-2px);
        }
        #predict-button:disabled {
            background-color: #bdbdbd; /* Gris deshabilitado */
            cursor: not-allowed;
            box-shadow: none;
        }

        #reset-button {
            flex-grow: 1; /* MÃ¡s angosto */
            background-color: var(--color-reset);
            color: white;
            box-shadow: 0 4px 10px rgba(108, 117, 125, 0.4);
        }
        #reset-button:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        /* --- RESULTADOS Y MENSAJES DE ESTADO --- */
        .result-box {
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 600;
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }
        .result-box span {
            margin-right: 10px;
            font-size: 1.5em;
        }

        /* Colores de estado mejorados */
        .success { 
            background-color: #e8f5e9; 
            color: var(--color-safe); 
            border: 1px solid var(--color-safe); 
        }
        .error { 
            background-color: #ffebee; 
            color: var(--color-danger); 
            border: 1px solid var(--color-danger); 
        }
        .warning { 
            background-color: #fff8e1; 
            color: var(--color-warning); 
            border: 1px solid var(--color-warning); 
        }

        /* Estilos para los datos principales */
        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 1.1em;
        }
        .data-item strong {
            font-weight: 700;
            color: var(--color-primary);
        }
        
        /* Ocultar la secciÃ³n de probabilidades que no se usa ahora */
        #probabilities-section {
            display: none;
        }
        /* --- SECCIÃ“N DE CÃMARA (NUEVOS ESTILOS) --- */
        .camera-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
        }

        .camera-controls {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            width: 100%;
            justify-content: center;
        }

        .action-button {
            padding: 10px 15px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
        }

        .primary-btn {
            background-color: var(--color-primary);
            color: white;
        }

        .secondary-btn {
            background-color: var(--color-secondary);
            color: white;
        }

        .reset-btn {
            background-color: var(--color-reset);
            color: white;
        }

        .primary-btn:hover, .secondary-btn:hover, .reset-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        /* ModificaciÃ³n para asegurar que el input file no se vea, pero siga siendo usable */
        #file-input {
            display: none;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 0 24 24" width="30px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.04 3H5.81l1.04-3zM19 17H5v-4.5h14V17z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>
            Detector de DistracciÃ³n al Volante
        </h1>
        <p class="subtitle">AnÃ¡lisis de la conducciÃ³n mediante Inteligencia Artificial (YOLOv8).</p>
        <div class="camera-section" id="camera-section">
            <video id="webcam-video" autoplay playsinline **muted** style="display: none; width: 100%; max-height: 350px; border-radius: 8px; border: 3px solid var(--color-secondary); object-fit: cover;"></video>
            <canvas id="photo-canvas" style="display: none;"></canvas>
            
            <div class="camera-controls">
                <button onclick="startCamera()" id="start-camera-button" class="action-button primary-btn">
                    Iniciar CÃ¡mara (Webcam/MÃ³vil)
                </button>
                <button onclick="takePhoto()" id="take-photo-button" class="action-button secondary-btn" style="display: none;">
                    Tomar Foto
                </button>
                <button onclick="stopCamera()" id="stop-camera-button" class="action-button reset-btn" style="display: none;">
                    Detener CÃ¡mara
                </button>
            </div>
            
            <p id="camera-status" class="subtitle" style="margin-top: 15px; color: #999;">O</p>
        </div>
        <div class="upload-section" id="upload-box">
            <input type="file" id="file-input" accept="image/*" style="display: none;">
            <p id="upload-text">ğŸ‘† Haz clic para subir una imagen o arrastra y suelta aquÃ­</p>
            <img id="image-preview" class="image-preview" src="#" alt="Vista previa de la imagen">
        </div>
        <h2>âš™ï¸ Ajustes de AnÃ¡lisis Adaptativo</h2>

        <div class="analysis-settings" style="display: flex; gap: 25px; margin-bottom: 25px; align-items: flex-start; flex-wrap: wrap;">
            
            <div class="control-group" style="flex-basis: 45%;">
                <label for="user_experience" style="font-weight: 600; display: block; margin-bottom: 5px; color: #555;">
                    ğŸ‘¤ Perfil del Conductor:
                </label>
                <select id="user_experience" name="user_experience" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em;">
                    <option value="Principiante">1. Principiante (MÃ¡s Riesgo)</option>
                    <option value="Intermedio" selected>2. Intermedio (EstÃ¡ndar)</option>
                    <option value="Avanzado">3. Avanzado (Menos Riesgo)</option>
                </select>
                <small style="color: #888;">Define la severidad de las alertas.</small>
            </div>

            <div class="control-group" style="flex-basis: 45%;">
                <label for="threshold_slider" style="font-weight: 600; display: block; margin-bottom: 5px; color: #555;">
                    ğŸ§  Umbral de Confianza (Threshold):
                </label>
                <input type="range" 
                    id="threshold_slider" 
                    name="threshold" 
                    min="0.1" 
                    max="0.95" 
                    step="0.05" 
                    value="0.5"
                    style="width: 100%; margin-bottom: 5px;">
                <span id="threshold_value" style="font-weight: 700; color: var(--color-primary);">0.50</span>
                <small style="display: block; color: #888;">(MÃ¡s bajo = MÃ¡s sensible a detecciones dÃ©biles)</small>
            </div>
        </div>
        <div class="button-group">
            <button onclick="predictImage()" id="predict-button" disabled>
                Analizar Imagen
            </button>
            <button onclick="resetInterface()" id="reset-button">
                Limpiar
            </button>
        </div>
        
        <div id="results-area">
            <h2>Resultados del AnÃ¡lisis</h2>
            <div id="status-message" class="result-box warning" style="display: none;"></div>
            
            <div class="data-item score-item">
                <span>PuntuaciÃ³n de Seguridad (0-100):</span> 
                <strong id="final-score">---</strong>
            </div>

            <div class="data-item">
                <span>Clase Predicha:</span> 
                <strong id="predicted-class">---</strong>
            </div>
            
            <div class="data-item">
                <span>Confianza de la PredicciÃ³n:</span> 
                <strong id="confidence">---</strong>
            </div>
            
            <div class="data-item impact-item" style="flex-direction: column; align-items: flex-start;">
                <span style="font-weight: 600; margin-bottom: 5px;">RecomendaciÃ³n y Impacto:</span> 
                <p id="impact-message" style="margin: 0; font-style: italic; color: #555;">---</p>
            </div>
            
            <div id="probabilities-section">
                </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('file-input');
        const imagePreview = document.getElementById('image-preview');
        const predictButton = document.getElementById('predict-button');
        const uploadText = document.getElementById('upload-text');
        const uploadBox = document.getElementById('upload-box');
        const statusMessage = document.getElementById('status-message');
        const predictedClass = document.getElementById('predicted-class');
        const confidenceDisplay = document.getElementById('confidence');
    // --- NUEVOS ELEMENTOS ---
        const thresholdSlider = document.getElementById('threshold_slider');
        const thresholdValueSpan = document.getElementById('threshold_value');
        const userExperienceSelect = document.getElementById('user_experience');
        
        // --- LÃ“GICA DE VOZ Y AJUSTES HUMANOS ---
        let voicesLoaded = false;
        let selectedSpanishVoice = null;
        const preferredDialects = [
            'es-ES', // EspaÃ±ol de EspaÃ±a (a menudo tiene voces de alta calidad)
            'es-MX', // EspaÃ±ol de MÃ©xico
            'es-US', // EspaÃ±ol de Estados Unidos (usado por Google/Android)
            'es'     // Catch-all para cualquier espaÃ±ol
        ];

        function loadVoices() {
            selectedSpanishVoice = null; // Reiniciar
            const voices = window.speechSynthesis.getVoices();
            
            // Lista de nombres de voces comunes en espaÃ±ol que suelen ser de alta calidad
            // Dejamos la lista, pero priorizaremos el dialecto
            const preferredNames = [
                'Google espaÃ±ol', 'Microsoft Helena', 'Microsoft Raul', 'Monica', 'Paulina'
            ];
            
            // 1. Intentar encontrar una voz por nombre
            for (const name of preferredNames) {
                selectedSpanishVoice = voices.find(voice => voice.name.includes(name));
                if (selectedSpanishVoice) break;
            }

            // 2. Si no se encontrÃ³ por nombre, buscar por dialecto
            if (!selectedSpanishVoice) {
                for (const lang of preferredDialects) {
                    selectedSpanishVoice = voices.find(voice => voice.lang === lang);
                    if (selectedSpanishVoice) break;
                }
            }

            voicesLoaded = true;
        }

        // Cargar las voces
        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices(); 
        }


        function speakMessage(textToSpeak, language = 'es-ES') {
            if (!('speechSynthesis' in window)) {
                console.warn("La API de Text-to-Speech no estÃ¡ soportada.");
                return;
            }
            
            if (!voicesLoaded) {
                loadVoices(); // Intenta cargar de nuevo si es necesario
            }

            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            
            // Asignar la voz y el idioma
            if (selectedSpanishVoice) {
                utterance.voice = selectedSpanishVoice;
                utterance.lang = selectedSpanishVoice.lang; // Usa el idioma de la voz encontrada
            } else {
                utterance.lang = language; // Usa el idioma predeterminado si falla la selecciÃ³n
                console.warn("No se encontrÃ³ una voz de alta calidad; usando la voz predeterminada del navegador.");
            }

            // Ajustes para sonar mÃ¡s humano
            utterance.pitch = 1.1; 
            utterance.rate = 1.0;  

            window.speechSynthesis.speak(utterance);
        } 

        // LÃ³gica para actualizar el valor visible del slider
        thresholdSlider.oninput = function() {
            thresholdValueSpan.innerHTML = parseFloat(this.value).toFixed(2);
        };
        // --- NUEVAS VARIABLES DE CÃMARA ---
        const webcamVideo = document.getElementById('webcam-video');
        const photoCanvas = document.getElementById('photo-canvas');
        const startCameraButton = document.getElementById('start-camera-button');
        const takePhotoButton = document.getElementById('take-photo-button');
        const stopCameraButton = document.getElementById('stop-camera-button');
        const cameraStatus = document.getElementById('camera-status');
        let currentStream = null; // Para guardar el stream y poder detenerlo

// --- FUNCIÃ“N PARA LIMPIAR LA INTERFAZ (MODIFICADA) ---
    Â  Â  function resetInterface() {
    Â  Â  Â  Â  // 1. Limpiar el input de archivo
    Â  Â  Â  Â  fileInput.value = '';

    Â  Â  Â  Â  // 2. Restaurar el estado inicial del Ã¡rea de subida
    Â  Â  Â  Â  imagePreview.style.display = 'none';
    Â  Â  Â  Â  imagePreview.src = '#';
    Â  Â  Â  Â  uploadText.style.display = 'block';
    Â  Â  Â  Â  uploadBox.style.display = 'block'; // Asegura que la caja de subida estÃ© visible
    Â  Â  Â  Â  
    Â  Â  Â  Â  // 3. Limpieza de cÃ¡mara (NUEVO)
    Â  Â  Â  Â  stopCamera();
    Â  Â  Â  Â  startCameraButton.style.display = 'block';
    Â  Â  Â  Â  takePhotoButton.style.display = 'none';
    Â  Â  Â  Â  stopCameraButton.style.display = 'none';
    Â  Â  Â  Â  cameraStatus.textContent = 'O';

    Â  Â  Â  Â  // 4. Desactivar y limpiar botones/resultados
    Â  Â  Â  Â  predictButton.disabled = true;
    Â  Â  Â  Â  statusMessage.style.display = 'none';
    Â  Â  Â  Â  statusMessage.className = 'result-box warning';
    Â  Â  Â  Â Â 
    Â  Â  Â  Â  predictedClass.textContent = '---';
    Â  Â  Â  Â  confidenceDisplay.textContent = '---';
    Â  Â  Â  Â Â 
    Â  Â  Â  Â  console.log('Interfaz reseteada.');
    Â  Â  }
    // --- FUNCIONES DE CÃMARA (Nuevas) ---

    Â  Â  /**
    Â  Â   * Inicia la cÃ¡mara y muestra el stream en el elemento <video>.
    Â  Â   */
        // --- FUNCIÃ“N PARA INICIAR LA CÃMARA (Mejorada para manejo de errores) ---
        function startCamera() {
            // 1. Limpieza inicial de interfaz y mensajes
            resetInterface(); 
            cameraStatus.textContent = 'Iniciando cÃ¡mara... por favor, acepta los permisos.';
            startCameraButton.disabled = true; // â­ NUEVO: Desactivar el botÃ³n para evitar clics mÃºltiples

            // Opciones para solicitar la cÃ¡mara trasera (por defecto)
            let constraints = {
                video: {
                    width: { ideal: 640 }, // Usamos ideal para mejor compatibilidad
                    height: { ideal: 480 },
                    facingMode: "environment" // CÃ¡mara trasera
                }
            };

            // FunciÃ³n que intenta acceder a la cÃ¡mara
            const attemptCameraAccess = (currentConstraints, isFallback = false) => {
                navigator.mediaDevices.getUserMedia(currentConstraints)
                    .then(stream => {
                        currentStream = stream;
                        webcamVideo.srcObject = stream;
                        webcamVideo.style.display = 'block';
                        uploadBox.style.display = 'none'; // Oculta la secciÃ³n de subida
                        
                        // â­ Manejo correcto de botones al Ã©xito
                        startCameraButton.style.display = 'none';
                        startCameraButton.disabled = false; 
                        takePhotoButton.style.display = 'block';
                        stopCameraButton.style.display = 'block';
                        
                        const cameraType = isFallback ? 'frontal' : 'trasera';
                        cameraStatus.innerHTML = `âœ… CÃ¡mara ${cameraType} activa. **Toma una foto para analizar.**`;
                    })
                    .catch(error => {
                        // Si el primer intento (trasera) falla, intentar el segundo (frontal)
                        if (!isFallback) {
                            console.warn("Fallo al acceder a la cÃ¡mara trasera. Intentando frontal...", error);
                            let fallbackConstraints = {
                                video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: "user" }
                            };
                            attemptCameraAccess(fallbackConstraints, true);
                            return;
                        }
                        
                        // â­ Si ambos fallan (Error definitivo)
                        console.error("Error definitivo al acceder a la cÃ¡mara.", error);
                        startCameraButton.disabled = false; // Volver a habilitar el botÃ³n
                        cameraStatus.innerHTML = 'âŒ Error: No se pudo acceder a ninguna cÃ¡mara.<br>AsegÃºrate de que la cÃ¡mara estÃ© conectada y que **diste permiso** al navegador.';
                        uploadBox.style.display = 'block'; // Mostrar de nuevo la opciÃ³n de subir
                        
                        // Restaurar botones a estado inicial
                        startCameraButton.style.display = 'block';
                        takePhotoButton.style.display = 'none';
                        stopCameraButton.style.display = 'none';
                    });
            };

            attemptCameraAccess(constraints); // Iniciar el intento
        }

    Â  Â  /**
    Â  Â   * Detiene el stream de la cÃ¡mara.
    Â  Â   */
    Â  Â  function stopCamera() {
    Â  Â  Â  Â  if (currentStream) {
    Â  Â  Â  Â  Â  Â  currentStream.getTracks().forEach(track => track.stop());
    Â  Â  Â  Â  Â  Â  currentStream = null;
    Â  Â  Â  Â  Â  Â  webcamVideo.srcObject = null;
    Â  Â  Â  Â  }
    Â  Â  Â  Â  webcamVideo.style.display = 'none';
    Â  Â  Â  Â  startCameraButton.style.display = 'block';
    Â  Â  Â  Â  takePhotoButton.style.display = 'none';
    Â  Â  Â  Â  stopCameraButton.style.display = 'none';
    Â  Â  Â  Â  uploadBox.style.display = 'block'; // Muestra de nuevo la secciÃ³n de subida
    Â  Â  Â  Â  cameraStatus.textContent = 'O';
    Â  Â  }

    Â  Â  /**
    Â  Â   * Captura un frame del video y lo convierte en archivo para anÃ¡lisis.
    Â  Â   */
    Â  Â  function takePhoto() {
    Â  Â  Â  Â  if (!currentStream) {
    Â  Â  Â  Â  Â  Â  alert("Primero inicia la cÃ¡mara.");
    Â  Â  Â  Â  Â  Â  return;
    Â  Â  Â  Â  }
    Â  Â  Â  Â  
    Â  Â  Â  Â  const context = photoCanvas.getContext('2d');
    Â  Â  Â  Â  
    Â  Â  Â  Â  // Asegura que el canvas tenga el mismo tamaÃ±o que el video para la captura
    Â  Â  Â  Â  photoCanvas.width = webcamVideo.videoWidth;
    Â  Â  Â  Â  photoCanvas.height = webcamVideo.videoHeight;
    Â  Â  Â  Â  
    Â  Â  Â  Â  context.drawImage(webcamVideo, 0, 0, photoCanvas.width, photoCanvas.height);
    Â  Â  Â  Â  
    Â  Â  Â  Â  // Detiene la cÃ¡mara inmediatamente despuÃ©s de tomar la foto
    Â  Â  Â  Â  stopCamera(); 
    Â  Â  Â  Â  
    Â  Â  Â  Â  // Convierte la imagen del canvas a Blob (formato de archivo)
    Â  Â  Â  Â  photoCanvas.toBlob(function(blob) {
    Â  Â  Â  Â  Â  Â  if (blob) {
    Â  Â  Â  Â  Â  Â  Â  Â  // Crea un objeto File temporal para simular la subida
    Â  Â  Â  Â  Â  Â  Â  Â  const photoFile = new File([blob], 'captured_image.png', { type: 'image/png' });
    Â  Â  Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  Â  Â  // Crea un DataTransfer y asigna el archivo al input (simulando una subida)
    Â  Â  Â  Â  Â  Â  Â  Â  const dataTransfer = new DataTransfer();
    Â  Â  Â  Â  Â  Â  Â  Â  dataTransfer.items.add(photoFile);
    Â  Â  Â  Â  Â  Â  Â  Â  fileInput.files = dataTransfer.files;

    Â  Â  Â  Â  Â  Â  Â  Â  // Muestra la imagen capturada en el Ã¡rea de vista previa
    Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.src = URL.createObjectURL(photoFile);
    Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.style.display = 'block';
    Â  Â  Â  Â  Â  Â  Â  Â  uploadText.style.display = 'none';
    Â  Â  Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  Â  Â  // Habilita el botÃ³n de predicciÃ³n
    Â  Â  Â  Â  Â  Â  Â  Â  predictButton.disabled = false;
    Â  Â  Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  Â  Â  cameraStatus.textContent = 'Foto capturada, lista para analizar.';
    Â  Â  Â  Â  Â  Â  Â  Â  
    Â  Â  Â  Â  Â  Â  } else {
    Â  Â  Â  Â  Â  Â  Â  Â  cameraStatus.textContent = 'âŒ Error al procesar la foto.';
    Â  Â  Â  Â  Â  Â  }
    Â  Â  Â  Â  }, 'image/png');
    Â  Â  }
        // --- MANEJO DE ARCHIVOS Y DRAG & DROP ---

        function handleFile(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    uploadText.style.display = 'none';
                    predictButton.disabled = false;
                    statusMessage.style.display = 'none'; // Limpiar mensaje de estado al subir nueva imagen
                    predictedClass.textContent = '---';
                    confidenceDisplay.textContent = '---';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
                uploadText.style.display = 'block';
                predictButton.disabled = true;
                alert('Por favor, sube un archivo de imagen vÃ¡lido.');
            }
        }

        // Evento de selecciÃ³n de archivo normal
    Â  Â  fileInput.onchange = function(event) {
    Â  Â  Â  Â  // Aseguramos detener la cÃ¡mara si se sube un archivo manualmente
    Â  Â  Â  Â  stopCamera(); 
    Â  Â  Â  Â  handleFile(event.target.files[0]);
    Â  Â  Â  Â  uploadBox.style.display = 'block'; // Aseguramos que la caja de subida estÃ© visible
    Â  Â  };
    Â  Â Â 
    Â  Â  // Permite hacer clic en el Ã¡rea de subida
    Â  Â  uploadBox.addEventListener('click', () => {
    Â  Â  Â  Â  // Solo permitimos el click si la cÃ¡mara no estÃ¡ activa
    Â  Â  Â  Â  if (currentStream) return; 
    Â  Â  Â  Â  fileInput.click();
    Â  Â  });
Â  Â 
        // Eventos Drag and Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadBox.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false); 
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        uploadBox.addEventListener('drop', handleDrop, false);
        uploadBox.addEventListener('dragenter', () => uploadBox.classList.add('hover'), false);
        uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('hover'), false);
        uploadBox.addEventListener('dragover', () => uploadBox.classList.add('hover'), false);


        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length) {
                fileInput.files = files; 
                handleFile(files[0]);
            }
            uploadBox.classList.remove('hover');
        }


        // --- LÃ“GICA DE PREDICCIÃ“N ---

        function predictImage() {
            const file = fileInput.files[0];
            if (!file) return;

            // Obtener los nuevos valores del Perfil y Umbral
            const thresholdValue = thresholdSlider.value;
            const userExperience = userExperienceSelect.value;
            
            // ... (Mostrar mensaje de carga, etc.) ...
            statusMessage.style.display = 'block';
            statusMessage.className = 'result-box warning';
            statusMessage.innerHTML = '<span>â³</span> Analizando... por favor, espera.';
            
            predictButton.disabled = true;

            const formData = new FormData();
            formData.append('file', file);
            // **AÃ±adir los nuevos datos al FormData**
            formData.append('threshold', thresholdValue); 
            formData.append('user_experience', userExperience);

            fetch('/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => Promise.reject(errorData));
                }
                return response.json();
            })
            .then(data => {
                predictButton.disabled = false;
                
                // Actualizar resultados bÃ¡sicos
                predictedClass.textContent = data.class_name;
                confidenceDisplay.textContent = data.confidence;
                
                // **NUEVO: Actualizar resultados de Perfil de Riesgo**
                const finalScore = document.getElementById('final-score');
                const impactMessage = document.getElementById('impact-message');
                
                // Asignar color al score (Verde >= 80, Amarillo 40-79, Rojo < 40)
                let scoreColor;
                if (data.final_score >= 80) {
                    scoreColor = 'var(--color-safe)'; // Score alto = Riesgo bajo
                } else if (data.final_score >= 40) {
                    scoreColor = 'var(--color-warning)';
                } else {
                    scoreColor = 'var(--color-danger)'; // Score bajo = Riesgo crÃ­tico
                }
                
                finalScore.textContent = `${data.final_score}/100`;
                finalScore.style.color = scoreColor;
                impactMessage.textContent = data.impact_message;

                // Actualizar mensaje de estado general
                // Usamos el 'message_type' (ej. 'critico', 'alto') para el color del box
                let icon = data.final_score >= 80 ? 'âœ…' : 'ğŸš¨';
                statusMessage.className = `result-box ${data.message_type === 'bajo' || data.message_type === 'moderado' ? 'warning' : 'error'}`;
                statusMessage.innerHTML = `<span>${icon}</span> ${data.message}`;
                // ** FUNCIONALIDAD DE VOZ: LECTURA DE TODO EL ANÃLISIS **
                // ----------------------------------------------------

                // 1. Crear el mensaje detallado para la voz
                let voiceMessage = `AnÃ¡lisis de ConducciÃ³n. `;

                // --- A. ClasificaciÃ³n del Estado ---
                if (data.risk_level === 'Bajo') {
                    voiceMessage += `Resultado exitoso: ${data.class_name}. `;
                } else {
                    // Para riesgo moderado, alto y crÃ­tico.
                    voiceMessage += `Â¡Alerta, Riesgo ${data.risk_level}! El sistema detecta: ${data.class_name}. `;
                }

                // --- B. PuntuaciÃ³n de Riesgo ---
                voiceMessage += `PuntuaciÃ³n de seguridad: ${data.final_score} de 100. `;

                // --- C. Mensaje de Impacto Adaptativo ---
                // Usamos el mensaje de impacto del servidor que incluye la adaptaciÃ³n por perfil.
                voiceMessage += `Mensaje de impacto: ${data.impact_message}.`;

                // 2. Llamar a la funciÃ³n de voz
                speakMessage(voiceMessage);
            })
            .catch(error => {
                // ... (Tu manejo de errores existente) ...
                predictButton.disabled = false;
                const errorMessage = error.error || 'Error de conexiÃ³n con el servidor o archivo no vÃ¡lido.';
                statusMessage.className = 'result-box error';
                statusMessage.innerHTML = `<span>âŒ</span> Error: ${errorMessage}`;
                console.error('Fetch error:', error);
            });
        }
    </script>
</body>
</html>
